# Alembic Quick Reference

## Common Commands

### Check Status
```bash
# Show current migration version
alembic current

# Show migration history
alembic history

# Show detailed history
alembic history --verbose
```

### Apply Migrations
```bash
# Apply all pending migrations
alembic upgrade head

# Apply next migration
alembic upgrade +1

# Apply to specific version
alembic upgrade <revision>
```

### Rollback Migrations
```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade <revision>

# Rollback all migrations
alembic downgrade base
```

### Create Migrations
```bash
# Auto-generate from model changes
alembic revision --autogenerate -m "description"

# Create empty migration
alembic revision -m "description"
```

### Preview SQL
```bash
# Show SQL without executing
alembic upgrade head --sql

# Show SQL for downgrade
alembic downgrade -1 --sql
```

### Troubleshooting
```bash
# Mark database as up-to-date without running migrations
alembic stamp head

# Mark as specific version
alembic stamp <revision>
```

## Docker Commands

When running in Docker:

```bash
# Check current version
docker-compose exec api alembic current

# Apply migrations
docker-compose exec api alembic upgrade head

# Create new migration
docker-compose exec api alembic revision --autogenerate -m "description"

# Show history
docker-compose exec api alembic history
```

## Workflow

### Making Model Changes

1. Edit `backend/app/db/models.py`
2. Generate migration: `alembic revision --autogenerate -m "description"`
3. Review generated file in `backend/alembic/versions/`
4. Apply migration: `alembic upgrade head`
5. Test your changes

### Production Deployment

1. **Backup database first!**
   ```bash
   pg_dump weaver > backup_$(date +%Y%m%d).sql
   ```

2. Apply migrations:
   ```bash
   alembic upgrade head
   ```

3. Verify:
   ```bash
   alembic current
   ```

4. If issues, rollback:
   ```bash
   alembic downgrade -1
   ```

## Tips

- Always review auto-generated migrations before applying
- Test migrations on a copy of production data first
- Keep migrations small and focused
- Never edit applied migrations - create a new one instead
- Use meaningful migration messages
- Backup before migrating production
